name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:


jobs:
  deploy:
    name: Deploy to cPanel
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2' # Adaptez à votre version
        extensions: mbstring, xml, bcmath, pdo_mysql, intl, gd
        coverage: none
        tools: composer

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: /tmp/composer-cache
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-
    - name: Verify PHP version compatibility
      run: |
        PHP_VERSION=$(php -r "echo PHP_MAJOR_VERSION.'.'.PHP_MINOR_VERSION;")
        echo "PHP version: $PHP_VERSION"
        if [[ "$PHP_VERSION" < "8.3" ]]; then
          echo "PHPUnit 12.4 requires PHP 8.3+, found $PHP_VERSION"
          echo "Downgrade to phpunit/phpunit:^11.0 or upgrade PHP"
          exit 1
        fi
    - name: Install dependencies
      run: |
        composer install --no-interaction --no-dev --optimize-autoloader --no-scripts --prefer-dist

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        passphrase: ""
        debug: true
        timeout: 120s
        script: |
          set -e

          echo "Mise à jour du code..."
          cd /home/univetmg/univet || { echo "ERREUR: Dossier univet introuvable"; exit 1; }

          git fetch origin main || { echo "ERREUR: git fetch échoué"; exit 1; }
          git reset --hard origin/main || { echo "ERREUR: git reset échoué"; exit 1; }

          echo "Installation des dépendances..."
          export COMPOSER_HOME="$HOME/.composer"
          composer install --no-interaction --no-dev --optimize-autoloader --no-scripts --prefer-dist || {
            echo "ERREUR: composer install échoué"
            composer diagnose
            exit 1
          }

          echo "Nettoyage du cache..."
          rm -rf var/cache/*
          php bin/console cache:warmup --env=prod --no-debug || {
            echo "ERREUR: cache:warmup échoué"
            echo "Contenu de .env :"
            cat .env | grep -v '^#' | grep .
            exit 1
          }

          echo "Permissions..."
          find var -type f -exec chmod 664 {} \; 2>/dev/null || true
          find var -type d -exec chmod 775 {} \; 2>/dev/null || true
          [ -f .env ] && chmod 600 .env

          echo "Lien symbolique..."
          rm -f ~/public_html
          ln -s /home/univetmg/univet/public ~/public_html || { echo "ERREUR: lien symbolique échoué"; exit 1; }

          echo "Déploiement terminé !

    - name: Success
      if: success()
      run: echo "Déploiement réussi !"

    - name: Failure
      if: failure()
      run: echo "Échec du déploiement. Consultez les logs."

    - name: Notify Discord - Success
      if: success()
      run: |
        curl -X POST -H "Content-Type: application/json" \
          -d '{
            "username": "GitHub Actions",
            "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
            "embeds": [{
              "title": "Déploiement réussi !",
              "url": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}",
              "color": 3066993,
              "fields": [
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Commit", "value": "`${{ github.sha }}`", "inline": true},
                {"name": "Auteur", "value": "${{ github.actor }}", "inline": true},
                {"name": "Message", "value": "${{ github.event.head_commit.message }}"},
                {"name": "Site", "value": "[univet.mg](https://univet.mg/)", "inline": false}
              ],
              "timestamp": "${{ github.event.head_commit.timestamp }}"
            }]
          }' ${{ secrets.DISCORD_WEBHOOK_URL }}

    - name: Notify Discord - Failure
      if: failure()
      run: |
        LOG_URL="https://univet.mg/var/log/prod.log"
        SSH_LOGS=$(ssh -i ~/.ssh/temp_key -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "tail -n 20 /home/univetmg/univet/var/log/prod.log 2>/dev/null || echo 'Pas de log Symfony'")

        curl -X POST -H "Content-Type: application/json" \
          -d '{
            "username": "GitHub Actions",
            "embeds": [{
              "title": "Déploiement échoué !",
              "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "color": 15158332,
              "fields": [
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Commit", "value": "`${{ github.sha }}`", "inline": true},
                {"name": "Erreur probable", "value": "Voir logs GitHub", "inline": false},
                {"name": "Dernières lignes de log Symfony", "value": "```'\"$SSH_LOGS\"'```", "inline": false}
              ]
            }]
          }' ${{ secrets.DISCORD_WEBHOOK_URL }}
