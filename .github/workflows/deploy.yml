name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:


jobs:
  deploy:
    name: Deploy to cPanel
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2' # Adaptez à votre version
        extensions: mbstring, xml, bcmath, pdo_mysql, intl, gd
        coverage: none
        tools: composer

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: /tmp/composer-cache
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: Install dependencies
      run: |
        composer install --no-interaction --no-dev --optimize-autoloader --no-scripts --prefer-dist

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        passphrase: ""
        debug: true
        timeout: 120s
        script: |
          set -e  # Arrête à la première erreur

          echo "Mise à jour du code..."
          cd /home/univetmg/univet || exit 1

          git fetch origin main
          git reset --hard origin/main
          
          git reset --hard origin/main
          
          echo "Commit déployé :"
          git rev-parse HEAD

          echo "Diagnostics Serveur:"
          php -v
          composer --version
          pwd
          ls -la
          
          echo "Forçage du timestamp pour index.php..."
          
          echo "Forçage du timestamp pour index.php..."
          touch public/index.php

          echo "Installation des dépendances (sans dev)..."
          export COMPOSER_HOME="$HOME/.composer"
          rm -rf vendor
          composer install --no-interaction --no-dev --optimize-autoloader --no-scripts --prefer-dist

          echo "Installation des assets..."
          php bin/console assets:install public --env=prod

          echo "Configuration production..."
          # Création de .env.local avec APP_SECRET si inexistant
          if [ ! -f .env.local ]; then
            echo "APP_SECRET=$(openssl rand -hex 16)" > .env.local
          fi
          
          # Compilation des variables d'environnement pour la prod
          # Cela génère .env.local.php et force APP_ENV=prod
          composer dump-env prod
          
          chmod 600 .env.local .env.local.php



          # Désactivation du profiler & routes de debug
          mv config/packages/web_profiler.yaml config/packages/web_profiler.yaml.disabled 2>/dev/null || true
          mv config/routes/web_profiler.yaml config/routes/web_profiler.yaml.disabled 2>/dev/null || true
          mv config/packages/debug.yaml config/packages/debug.yaml.disabled 2>/dev/null || true

          echo "Exécution des migrations de base de données..."
          php bin/console doctrine:migrations:migrate --no-interaction --env=prod --no-debug || true

          echo "Nettoyage et réchauffement du cache..."
          # Tentative de correction des permissions avant suppression
          chmod -R 777 var/cache > /dev/null 2>&1 || true
          rm -rf var/cache/* > /dev/null 2>&1 || true
          
          # Utilisation de cache:clear qui est plus robuste
          php bin/console cache:clear --env=prod --no-debug
          php bin/console cache:warmup --env=prod --no-debug

          echo "Permissions sécurisées..."
          # On s'assure que var (cache et logs) est accessible
          chmod -R 777 var > /dev/null 2>&1 || true
          chmod 600 .env.local 2>/dev/null || true

          echo "Mise à jour du lien symbolique..."
          rm -f ~/public_html
          ln -s /home/univetmg/univet/public ~/public_html

          echo "Déploiement terminé avec succès !"
          echo "Site : https://univet.mg/"

    - name: Success
      if: success()
      run: echo "Déploiement réussi !"

    - name: Failure
      if: failure()
      run: echo "Échec du déploiement. Consultez les logs."

    - name: Notify Discord - Success
      if: success()
      run: |
        curl -X POST -H "Content-Type: application/json" \
          -d '{
            "username": "GitHub Actions",
            "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
            "embeds": [{
              "title": "Déploiement réussi !",
              "url": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}",
              "color": 3066993,
              "fields": [
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Commit", "value": "`${{ github.sha }}`", "inline": true},
                {"name": "Auteur", "value": "${{ github.actor }}", "inline": true},
                {"name": "Message", "value": "${{ github.event.head_commit.message }}"},
                {"name": "Site", "value": "[univet.mg](https://univet.mg/)", "inline": false}
              ],
              "timestamp": "${{ github.event.head_commit.timestamp }}"
            }]
          }' ${{ secrets.DISCORD_WEBHOOK_URL }}

    - name: Notify Discord - Failure
      if: failure()
      run: |
        curl -X POST -H "Content-Type: application/json" \
          -d '{
            "username": "GitHub Actions",
            "embeds": [{
              "title": "Déploiement échoué !",
              "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "color": 15158332,
              "fields": [
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Commit", "value": "`${{ github.sha }}`", "inline": true},
                {"name": "Auteur", "value": "${{ github.actor }}", "inline": true},
                {"name": "Message", "value": "${{ github.event.head_commit.message }}"},
                {"name": "Action", "value": "Consultez les logs GitHub et Symfony pour plus de détails", "inline": false}
              ]
            }]
          }' ${{ secrets.DISCORD_WEBHOOK_URL }}
