name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:


jobs:
  deploy:
    name: Deploy to cPanel
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2' # Adaptez à votre version
        extensions: mbstring, xml, bcmath, pdo_mysql, intl, gd
        coverage: none
        tools: composer

    - name: Cache Composer dependencies
      uses: actions/cache@v4
      with:
        path: /tmp/composer-cache
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: Install dependencies
      run: |
        composer install --no-interaction --no-dev --optimize-autoloader --no-scripts --prefer-dist

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.SSH_PORT }}
        passphrase: ""
        debug: true
        timeout: 120s
        script: |
          set -e  # Arrête à la première erreur

          echo "Mise à jour du code..."
          cd /home/univetmg/univet || exit 1

          git fetch origin main
          git reset --hard origin/main
          
          echo "Commit déployé :"
          git rev-parse HEAD
          
          echo "Forçage du timestamp pour index.php..."
          touch public/index.php

          echo "Installation des dépendances (sans dev)..."
          export COMPOSER_HOME="$HOME/.composer"
          composer install --no-interaction --no-dev --optimize-autoloader --no-scripts --prefer-dist

          echo "Configuration production (.env)..."
          # .env propre (sans secret)
          grep -v '^#' .env > temp.env && mv temp.env .env
          echo "APP_ENV=prod" >> .env
          echo "APP_DEBUG=0" >> .env

          # .env.local avec secret (si absent)
          if [ ! -f .env.local ]; then
            echo "APP_SECRET=$(openssl rand -hex 16)" > .env.local
          fi
          chmod 600 .env.local

          echo "Désactivation des outils de dev en prod..."
          # Bundles dev → dev/test only
          sed -i "/MakerBundle\|FixturesBundle\|ProfilerBundle/s/=> \['all' => true\]/=> ['dev' => true, 'test' => true]/" config/bundles.php || true
          sed -i "/MakerBundle\|FixturesBundle\|ProfilerBundle/s/=> \['dev' => true\]/&/" config/bundles.php || true

          # Dés actifs profiler & routes
          mv config/packages/web_profiler.yaml config/packages/web_profiler.yaml.disabled 2>/dev/null || true
          mv config/routes/web_profiler.yaml config/routes/web_profiler.yaml.disabled 2>/dev/null || true
          mv config/packages/debug.yaml config/packages/debug.yaml.disabled 2>/dev/null || true

          echo "Nettoyage et réchauffement du cache..."
          rm -rf var/cache/*
          php bin/console cache:warmup --env=prod --no-debug

          echo "Permissions sécurisées..."
          find var -type f -exec chmod 664 {} \; 2>/dev/null || true
          find var -type d -exec chmod 775 {} \; 2>/dev/null || true
          chmod 600 .env.local 2>/dev/null || true

          echo "Mise à jour du lien symbolique..."
          rm -f ~/public_html
          ln -s /home/univetmg/univet/public ~/public_html

          echo "Déploiement terminé avec succès !"
          echo "Site : https://univet.mg/"

    - name: Success
      if: success()
      run: echo "Déploiement réussi !"

    - name: Failure
      if: failure()
      run: echo "Échec du déploiement. Consultez les logs."

    - name: Notify Discord - Success
      if: success()
      run: |
        curl -X POST -H "Content-Type: application/json" \
          -d '{
            "username": "GitHub Actions",
            "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
            "embeds": [{
              "title": "Déploiement réussi !",
              "url": "https://github.com/${{ github.repository }}/commit/${{ github.sha }}",
              "color": 3066993,
              "fields": [
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Commit", "value": "`${{ github.sha }}`", "inline": true},
                {"name": "Auteur", "value": "${{ github.actor }}", "inline": true},
                {"name": "Message", "value": "${{ github.event.head_commit.message }}"},
                {"name": "Site", "value": "[univet.mg](https://univet.mg/)", "inline": false}
              ],
              "timestamp": "${{ github.event.head_commit.timestamp }}"
            }]
          }' ${{ secrets.DISCORD_WEBHOOK_URL }}

    - name: Notify Discord - Failure
      if: failure()
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        LOG_URL="https://univet.mg/var/log/prod.log"
        SSH_LOGS=$(ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "tail -n 20 /home/univetmg/univet/var/log/prod.log 2>/dev/null || echo 'Pas de log Symfony'")

        curl -X POST -H "Content-Type: application/json" \
          -d '{
            "username": "GitHub Actions",
            "embeds": [{
              "title": "Déploiement échoué !",
              "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "color": 15158332,
              "fields": [
                {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "Commit", "value": "`${{ github.sha }}`", "inline": true},
                {"name": "Erreur probable", "value": "Voir logs GitHub", "inline": false},
                {"name": "Dernières lignes de log Symfony", "value": "```'\"$SSH_LOGS\"'```", "inline": false}
              ]
            }]
          }' ${{ secrets.DISCORD_WEBHOOK_URL }}
